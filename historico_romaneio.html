
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Histórico de Romaneios</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial; background: #f0f0f0; padding: 20px; }
    h1 { margin-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    th { background: #ddd; }
    .filtros input, .filtros select { padding: 6px; margin: 4px; }
  </style>
</head>
<body>
  <h1>Histórico de Romaneios</h1>

  <div class="filtros">
    <input type="text" id="filtroNome" placeholder="Filtrar por nome">
    <select id="filtroTipo">
      <option value="">Todos os tipos</option>
      <option value="spool">Spool</option>
      <option value="suporte">Suporte</option>
    </select>
    <input type="date" id="filtroData">
    <input type="text" id="filtroServico" placeholder="Filtrar por serviço">
    <button onclick="filtrar()">Filtrar</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Nome</th>
        <th>Tipo</th>
        <th>Serviço</th>
<th hidden>rawServico</th>
        <th>Data</th>
        <th>Download</th>
      </tr>
    </thead>
    <tbody id="tabela"></tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDGeF8d07YUKYpp3ZJJAKBr9R-JpgTXPbg",
      authDomain: "romaneio-palmont.firebaseapp.com",
      projectId: "romaneio-palmont"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let registros = [];

    async function carregar() {
      const snap = await db.collection("romaneios").orderBy("createdAt", "desc").get();
      registros = snap.docs.map(doc => {
        const d = doc.data();
        return {
          nome: d.nome || "",
          tipo: d.tipo || "",
          servico: d.servico || "",
          data: d.createdAt?.toDate() || null,
          url: d.url || ""
        };
      });
      renderizar(registros);
    }

    function renderizar(lista) {
      const tbody = document.getElementById("tabela");
      tbody.innerHTML = "";
      lista.forEach(item => {
        const tr = document.createElement("tr");
        const dataFormatada = item.data ? item.data.toLocaleString("pt-BR") : "-";
        tr.innerHTML = `
          <td>${item.nome}</td>
          <td>${item.tipo}</td>
          <td>${item.servico}</td>
          <td>${dataFormatada}</td>
          <td><a href="${item.url}" target="_blank">Download</a></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function filtrar() {
      const nome = document.getElementById("filtroNome").value.toLowerCase();
      const tipo = document.getElementById("filtroTipo").value;
      const dataFiltro = document.getElementById("filtroData").valueAsDate;
      const fim = document.getElementById("filtroFim").valueAsDate;
      const servico = document.getElementById('filtroServico').value.toLowerCase();
      const filtrado = registros.filter(r => {
        const nomeOk = !nome || r.nome.toLowerCase().includes(nome);
        const tipoOk = !tipo || r.tipo === tipo;
        const dataOk = !dataFiltro || r.data >= dataFiltro;
        const servicoOk = !servico || r.servico.toLowerCase().includes(servico);
        return nomeOk && tipoOk && servicoOk && dataOk;
      });
      renderizar(filtrado);
    }

    carregar();
  </script>
</body>
</html>
