<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Histórico de Romaneios</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { 
      font-family: Arial; 
      background: #000; 
      padding: 20px; 
      color: white;
    }
    h1 { 
      margin-bottom: 10px; 
      color: white;
    }
    table { 
      border-collapse: collapse; 
      width: 100%; 
      margin-top: 15px; 
      background-color: #1e1e1e;
      color: white;
    }
    th, td { 
      padding: 10px; 
      border: 1px solid #444; 
      text-align: left; 
    }
    th { 
      background: #28a745; 
      color: white;
    }
    .filtros input, .filtros select { 
      padding: 6px; 
      margin: 4px; 
      border-radius: 4px;
      border: 1px solid #444;
      background-color: #2c2c2c;
      color: white;
    }
    .filtros button {
      padding: 6px 12px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .filtros button:hover {
      background-color: #0056b3;
    }
    a {
      color: #17a2b8;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>Histórico de Romaneios</h1>

  <div class="filtros">
    <input type="text" id="filtroNome" placeholder="Filtrar por nome">
    <select id="filtroTipo">
      <option value="">Todos os tipos</option>
      <option value="spool">Spool</option>
      <option value="suporte">Suporte</option>
    </select>
    <input type="date" id="filtroData">
    <input type="text" id="filtroServico" placeholder="Filtrar por serviço">
    <button onclick="filtrar()">Filtrar</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Nome</th>
        <th>Tipo</th>
        <th>Serviço</th>
        <th>Data</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="tabela"></tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDGeF8d07YUKYpp3ZJJAKBr9R-JpgTXPbg",
      authDomain: "romaneio-palmont.firebaseapp.com",
      projectId: "romaneio-palmont",
      storageBucket: "romaneio-palmont.appspot.com",
      messagingSenderId: "378221539005",
      appId: "1:378221539005:web:1dba5391f18fd057d35a56"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let registros = [];

    async function carregar() {
      try {
        const snap = await db.collection("romaneios")
          .orderBy("createdAt", "desc")
          .get();
          
        registros = snap.docs.map(doc => {
          const d = doc.data();
          return {
            id: doc.id,
            nome: d.nome || "",
            tipo: d.tipo || "",
            servico: d.servico || "",
            data: d.createdAt?.toDate() || null,
            url: d.url || ""
          };
        });
        
        renderizar(registros);
      } catch (error) {
        console.error("Erro ao carregar histórico:", error);
        alert("Erro ao carregar o histórico de romaneios.");
      }
    }

    function renderizar(lista) {
      const tbody = document.getElementById("tabela");
      tbody.innerHTML = "";
      
      if (lista.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.textContent = "Nenhum romaneio encontrado";
        td.style.textAlign = "center";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      
      lista.forEach(item => {
        const tr = document.createElement("tr");
        const dataFormatada = item.data ? item.data.toLocaleString("pt-BR") : "-";
        tr.innerHTML = `
          <td>${item.nome}</td>
          <td>${item.tipo}</td>
          <td>${item.servico}</td>
          <td>${dataFormatada}</td>
          <td>
            <a href="${item.url}" target="_blank">Download</a> | 
            <a href="#" onclick="copiarLink('${item.url}')">Copiar Link</a>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function filtrar() {
      const nome = document.getElementById("filtroNome").value.toLowerCase();
      const tipo = document.getElementById("filtroTipo").value;
      const dataFiltro = document.getElementById("filtroData").valueAsDate;
      const servico = document.getElementById('filtroServico').value.toLowerCase();
      
      const filtrado = registros.filter(r => {
        const nomeOk = !nome || r.nome.toLowerCase().includes(nome);
        const tipoOk = !tipo || r.tipo === tipo;
        const dataOk = !dataFiltro || (r.data && r.data.toDateString() === dataFiltro.toDateString());
        const servicoOk = !servico || r.servico.toLowerCase().includes(servico);
        return nomeOk && tipoOk && servicoOk && dataOk;
      });
      
      renderizar(filtrado);
    }

    function copiarLink(url) {
      const input = document.createElement('input');
      input.value = url;
      document.body.appendChild(input);
      input.select();
      document.execCommand('copy');
      document.body.removeChild(input);
      alert("Link copiado para a área de transferência!");
      return false;
    }

    // Carrega os dados quando a página é aberta
    carregar();
  </script>
</body>
</html>
