<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Romaneio de Suporte</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        /* Seus estilos CSS permanecem os mesmos */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
        }
        /* ... (mantenha todo o restante do CSS igual) ... */
    </style>
</head>
<body>
    <!-- Seu HTML permanece o mesmo até a seção de scripts -->
    <script>
        let data = [];
        let filteredData = [];
        let columnIndexes = {};
        let editedRows = new Set();
        let qrScanner;
        const excelFileURL = "TESTE.xlsx";
        const rowsPerPage = 500;

        const hiddenColumns = [
            "desenho suporte", "informações", "isométrico", "peso (kg)", "cond. pintura",
            "área superfície", "data corte", "data acoplamento", "data solda",
            "data jato/pintura", "número romaneio", "data romaneio", "data recebimento",
            "observação", "area m² unitário", "data cadastro", "rev", "prog. fab.", "executante", "linha", "spool",
            "localização", "status", "peso unitário", "qtde enviada", "obs romaneio", "qtde", "saldo", "tipo de suporte", "tipo estrutura", "id", "serviço",
            "identificação 2", "area m²", "peso"
        ];

        // Função para carregar a lista de serviços quando o select for clicado
        function loadServicosOnClick() {
            const select = document.getElementById("servicoFilter");

            // Se já carregou os serviços, não faz nada
            if (select.options.length > 1) return;

            // Limpa o select (mantendo apenas a primeira opção)
            while (select.options.length > 1) {
                select.remove(1);
            }

            // Adiciona opção de carregamento
            const loadingOption = document.createElement("option");
            loadingOption.value = "";
            loadingOption.textContent = "Carregando serviços...";
            select.appendChild(loadingOption);

            fetch(excelFileURL)
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao carregar o arquivo.");
                    return response.arrayBuffer();
                })
                .then(arrayBuffer => {
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "", raw: false });

                    const servicoIndex = getColumnIndex(jsonData[0], "serviço");
                    if (servicoIndex === -1) return;

                    const servicos = [...new Set(jsonData.slice(1).map(row => row[servicoIndex]).filter(Boolean)];

                    // Remove a opção de carregamento
                    select.remove(1);

                    // Adiciona os serviços encontrados
                    servicos.sort().forEach(servico => {
                        const option = document.createElement("option");
                        option.value = servico;
                        option.textContent = servico;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error("Erro ao carregar serviços:", error);
                    select.remove(1);
                    const errorOption = document.createElement("option");
                    errorOption.value = "";
                    errorOption.textContent = "Erro ao carregar serviços";
                    select.appendChild(errorOption);
                });
        }

        // Carrega os dados de um serviço específico
        function loadServicoData() {
            const servicoSelecionado = document.getElementById("servicoFilter").value;
            if (!servicoSelecionado) {
                alert("Selecione um serviço primeiro!");
                return;
            }

            fetch(excelFileURL)
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao carregar o arquivo.");
                    return response.arrayBuffer();
                })
                .then(arrayBuffer => {
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "", raw: false });

                    const servicoIndex = getColumnIndex(jsonData[0], "serviço");
                    if (servicoIndex === -1) return;

                    const filteredRows = jsonData.slice(1).filter(row => row[servicoIndex] === servicoSelecionado);

                    data = [jsonData[0], ...filteredRows];
                    filteredData = filteredRows;

                    findColumnIndexes();
                    renderTable();
                })
                .catch(error => {
                    console.error("Erro ao carregar dados do serviço:", error);
                    alert("Não foi possível carregar os dados do serviço.");
                });
        }

        // ... (mantenha todas as outras funções como estão) ...

        // Inicializa quando o documento estiver pronto
        document.addEventListener("DOMContentLoaded", () => {
            // Adiciona o evento para carregar serviços quando o select for clicado
            document.getElementById("servicoFilter").addEventListener("click", loadServicosOnClick);

            // Adiciona o evento para carregar os dados quando um serviço for selecionado
            document.getElementById("servicoFilter").addEventListener("change", function() {
                if (this.value) {
                    loadServicoData();
                }
            });
        });
    </script>
</body>
</html>