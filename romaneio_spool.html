<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Romaneio Spool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>body { font-family: sans-serif; padding: 1rem; }</style>
</head>
<body>
    <h2>Romaneio Spool</h2>
    <input type="file" id="excelFile" />
    <table border="1" id="tabela"></table>

    <script>
    let data = [];
    let columnIndexes = {};
    let editedRows = new Set();
    let currentFileName = "spool.xlsx";

    function getRowId(row) {
        if (!row || !columnIndexes) return null;
        const idIndex = columnIndexes["id_spool"];
        return row[idIndex]?.toString().trim().toLowerCase() || null;
    }

    document.getElementById("excelFile").addEventListener("change", function(e) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const dataArray = new Uint8Array(e.target.result);
            const workbook = XLSX.read(dataArray, { type: "array" });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
            if (jsonData.length === 0) return alert("Planilha vazia");
            data = jsonData;
            mapearColunas();
            aplicarEdicoes();
            renderTabela();
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    });

    function mapearColunas() {
        columnIndexes = {};
        data[0].forEach((name, i) => {
            columnIndexes[name.trim().toLowerCase()] = i;
        });
    }

    function aplicarEdicoes() {
        const edits = JSON.parse(localStorage.getItem("spool_edicoes") || "{}");
        data.forEach((row, i) => {
            const id = getRowId(row);
            if (id && edits[id]) {
                row[columnIndexes["data do romaneio"]] = edits[id].dataRomaneio;
                row[columnIndexes["obs romaneio"]] = edits[id].obsRomaneio;
                editedRows.add(i);
            }
        });
    }

    function salvarEdicao(index) {
        const row = data[index];
        const id = getRowId(row);
        if (!id) return;
        const edits = JSON.parse(localStorage.getItem("spool_edicoes") || "{}");
        edits[id] = {
            dataRomaneio: row[columnIndexes["data do romaneio"]],
            obsRomaneio: row[columnIndexes["obs romaneio"]]
        };
        localStorage.setItem("spool_edicoes", JSON.stringify(edits));
    }

    function renderTabela() {
        const tabela = document.getElementById("tabela");
        tabela.innerHTML = "";
        const thead = tabela.insertRow();
        data[0].forEach(col => thead.insertCell().textContent = col);
        data.slice(1).forEach((row, i) => {
            const tr = tabela.insertRow();
            row.forEach((val, j) => {
                const td = tr.insertCell();
                td.textContent = val;
                if (columnIndexes["data do romaneio"] === j || columnIndexes["obs romaneio"] === j) {
                    td.contentEditable = true;
                    td.onblur = () => {
                        data[i + 1][j] = td.textContent.trim();
                        salvarEdicao(i + 1);
                    };
                }
            });
        });
    }
    </script>
</body>
</html>